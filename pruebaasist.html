import React, { useState, useEffect } from 'react';
import { Clock, Mic, Music, Users, FileText, Download, Trash2, Plus, PlayCircle, Save, FileSpreadsheet, RotateCcw, Monitor } from 'lucide-react';

export default function App() {
  // --- ESTADO Y CONFIGURACIÓN ---
  const [step, setStep] = useState(1);
  
  // Datos generales del programa
  const [programData, setProgramData] = useState({
    title: '',
    theme: '',
    duration: 15, // minutos por defecto
    presenters: [],
    school: 'Vicente Aleixandre',
    location: 'La Algaba'
  });
  
  const [newPresenter, setNewPresenter] = useState('');

  // Estructura de la escaleta (Secciones)
  // IDs fijos para Intro y Outro para evitar que se borren accidentalmente
  const [sections, setSections] = useState([
    { 
      id: 'intro', 
      type: 'intro', 
      title: 'Sintonía y Presentación', 
      duration: 1, 
      description: 'Bienvenida y presentación del tema.', 
      sound: 'Sintonía del programa (Fade In -> Fondo)', 
      speakers: ['Todos'] 
    },
    { 
      id: 'outro', 
      type: 'outro', 
      title: 'Despedida y Cierre', 
      duration: 1, 
      description: 'Conclusiones y redes sociales.', 
      sound: 'Sintonía de cierre (Fondo -> Fade Out)', 
      speakers: ['Todos'] 
    }
  ]);

  // Tipos de secciones que el usuario puede añadir
  const sectionTypes = [
    { type: 'content', label: 'Desarrollo / Charla', defaultSound: 'Fondo musical suave', defaultDuration: 3 },
    { type: 'interview', label: 'Entrevista', defaultSound: 'Sin música de fondo', defaultDuration: 4 },
    { type: 'music', label: 'Pausa Musical', defaultSound: 'Canción a primer plano', defaultDuration: 3 },
    { type: 'news', label: 'Noticias / Informativo', defaultSound: 'Ráfaga de noticias', defaultDuration: 2 },
    { type: 'debate', label: 'Debate / Tertulia', defaultSound: 'Fondo dinámico', defaultDuration: 5 },
  ];

  // --- LÓGICA Y CÁLCULOS ---

  // Calcular duración total
  const totalDuration = sections.reduce((acc, curr) => acc + (parseInt(curr.duration) || 0), 0);
  const isOverTime = totalDuration > programData.duration;

  // Manejadores de eventos
  const addPresenter = () => {
    if (newPresenter.trim()) {
      setProgramData({
        ...programData,
        presenters: [...programData.presenters, newPresenter.trim()]
      });
      setNewPresenter('');
    }
  };

  const removePresenter = (index) => {
    const newList = [...programData.presenters];
    newList.splice(index, 1);
    setProgramData({...programData, presenters: newList});
  };

  const addSection = (typeConfig) => {
    const newSection = {
      id: Date.now(),
      type: typeConfig.type,
      title: typeConfig.label,
      duration: typeConfig.defaultDuration,
      description: 'Escribe aquí el contenido...',
      sound: typeConfig.defaultSound,
      speakers: []
    };
    
    // Insertar la nueva sección ANTES del cierre (que es el último elemento)
    const newSections = [...sections];
    // Encontramos el índice del cierre
    const outroIndex = newSections.findIndex(s => s.type === 'outro');
    if (outroIndex !== -1) {
        newSections.splice(outroIndex, 0, newSection);
    } else {
        newSections.push(newSection);
    }
    setSections(newSections);
  };

  const removeSection = (id) => {
    if (id === 'intro' || id === 'outro') return; // Proteger intro y cierre
    setSections(sections.filter(s => s.id !== id));
  };

  const updateSection = (id, field, value) => {
    setSections(sections.map(s => s.id === id ? { ...s, [field]: value } : s));
  };

  // --- GENERADOR DE GUION (LITERARIO Y TÉCNICO) ---
  const generateScriptContent = () => {
    const mainPresenter = programData.presenters[0] || 'Presentador/a';
    const presenterList = programData.presenters.length > 0 ? programData.presenters : ['Locutor 1', 'Locutor 2'];
    
    return sections.map((section, index) => {
      // Calcular código de tiempo (Timecode)
      let timeStart = 0;
      for(let i=0; i<index; i++) timeStart += (parseInt(sections[i].duration) || 0);
      const timeEnd = timeStart + (parseInt(section.duration) || 0);
      const formattedTime = `${timeStart}:00 - ${timeEnd}:00`;

      // Asignar locutor rotativo para secciones centrales
      let currentSpeaker = 'Locutor';
      // Excluir intro y outro del contador para la rotación para que sea más natural
      if (section.type !== 'intro' && section.type !== 'outro') {
          const contentIndex = sections.filter(s => s.type !== 'intro' && s.type !== 'outro').indexOf(section);
          currentSpeaker = presenterList[contentIndex % presenterList.length];
      } else {
          currentSpeaker = mainPresenter;
      }

      // Generar texto basado en las plantillas subidas
      let content = '';
      if (section.type === 'intro') {
        content = `(Suena Sintonía del programa)\n\n${mainPresenter}: "En la Radio Escolar ${programData.school}..."\n\n(Baja sintonía a fondo)\n\n${mainPresenter}: "¡Buenos días! Soy ${mainPresenter} y os presento un nuevo programa de radio. El título de hoy es: ${programData.title}."\n\n${presenterList.length > 1 ? presenterList[1] : 'Locutor 2'}: "En este programa vamos a hablar de ${programData.theme}."\n\nTodos: "¡Comenzamos!"`;
      } else if (section.type === 'outro') {
        content = `${currentSpeaker}: "Y bueno, esto es todo por hoy, esperamos que os haya gustado y nos vemos la semana que viene."\n\n${mainPresenter}: "Recuerda que en cualquier momento puedes escucharnos y vernos en el canal de Youtube de la Radio Escolar ${programData.school}."\n\nTodos: "¡Nos despedimos desde ${programData.location}!"\n\n(Sube sintonía hasta final)`;
      } else if (section.type === 'interview') {
        content = `${currentSpeaker}: "Para profundizar en ${programData.theme}, hoy tenemos una entrevista muy especial..."\n\n(Escribir aquí: Presentación del invitado y preguntas)`;
      } else if (section.type === 'music') {
        content = `(Locutor presenta la canción)\n${currentSpeaker}: "Vamos a hacer una pausa para escuchar..."\n\n(Suena música a primer plano)`;
      } else if (section.type === 'news') {
         content = `${currentSpeaker}: "Pasamos ahora a las noticias de nuestro centro..."\n\n- Noticia 1:\n- Noticia 2:`;
      } else {
        content = `${currentSpeaker}: "Continuamos con ${section.title}. En relación a ${programData.theme}..."\n\n(Desarrollar el contenido aquí: \n- Idea 1\n- Idea 2\n- Idea 3)`;
      }

      return {
        ...section,
        formattedTime,
        generatedText: content,
        assignedSpeaker: currentSpeaker
      };
    });
  };

  const finalScript = generateScriptContent();

  // --- EXPORTACIÓN ---
  const downloadCSV = () => {
    let csvContent = "data:text/csv;charset=utf-8,";
    // BOM para que Excel reconozca acentos automáticamente
    csvContent += "\uFEFF"; 
    csvContent += "TIEMPO;CONTROL SONIDO (TÉCNICO);LOCUTOR;TEXTO / CONTENIDO\n";

    finalScript.forEach(row => {
      // Limpiamos saltos de línea y comillas para CSV
      const cleanText = row.generatedText.replace(/"/g, '""'); 
      const cleanSound = row.sound.replace(/"/g, '""');
      const speaker = row.type === 'intro' || row.type === 'outro' ? 'VARIOS' : row.assignedSpeaker;
      
      // Usamos punto y coma como separador, más común en Excel español
      csvContent += `"${row.formattedTime}";"${cleanSound}";"${speaker}";"${cleanText}"\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Guion_${programData.title.replace(/\s+/g, '_')}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-slate-100 p-4 font-sans text-slate-800">
      <div className="max-w-6xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden border border-slate-200">
        
        {/* ENCABEZADO ESTILO "APP" */}
        <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-white flex justify-between items-center shadow-md">
          <div className="flex items-center gap-4">
            <div className="bg-white/20 p-3 rounded-full backdrop-blur-sm">
                <Mic className="w-8 h-8 text-white" />
            </div>
            <div>
              <h1 className="text-2xl font-bold tracking-tight">Radio Escolar Manager</h1>
              <p className="text-blue-100 text-sm font-medium opacity-90">Asistente de Guion para 6º de Primaria</p>
            </div>
          </div>
          <div className="hidden md:block text-right bg-white/10 px-4 py-2 rounded-lg">
             <div className="text-xs uppercase tracking-wider opacity-75">Emisora</div>
             <div className="font-bold">{programData.school}</div>
          </div>
        </div>

        {/* BARRA DE PROGRESO / NAVEGACIÓN */}
        <div className="flex border-b bg-white sticky top-0 z-10 shadow-sm">
          {[
            { num: 1, label: 'Configuración', icon: Users },
            { num: 2, label: 'Escaleta', icon: Clock },
            { num: 3, label: 'Guion Final', icon: FileText }
          ].map((item) => (
            <button 
              key={item.num}
              onClick={() => setStep(item.num)}
              className={`flex-1 p-4 flex flex-col md:flex-row items-center justify-center gap-2 transition-all border-b-4 ${
                step === item.num 
                  ? 'border-blue-600 bg-blue-50 text-blue-700 font-bold' 
                  : 'border-transparent text-gray-500 hover:bg-gray-50'
              }`}
            >
              <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${step === item.num ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>
                {item.num}
              </span>
              <span className="hidden md:inline">{item.label}</span>
              <item.icon size={16} className="md:hidden"/>
            </button>
          ))}
        </div>

        <div className="p-4 md:p-8 min-h-[500px]">
          
          {/* --- PASO 1: CONFIGURACIÓN DEL PROGRAMA --- */}
          {step === 1 && (
            <div className="animate-in slide-in-from-right-4 duration-500 space-y-8 max-w-4xl mx-auto">
              
              <div className="bg-blue-50 border border-blue-100 p-6 rounded-xl flex items-start gap-4">
                  <Monitor className="text-blue-500 w-12 h-12 flex-shrink-0" />
                  <div>
                      <h3 className="text-lg font-bold text-blue-900 mb-1">¡Vamos a diseñar tu programa!</h3>
                      <p className="text-blue-700">Rellena los datos básicos. No te preocupes por el guion todavía, el asistente lo escribirá por ti usando los nombres que pongas aquí.</p>
                  </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="space-y-4">
                  <label className="block">
                    <span className="text-gray-700 font-bold mb-1 block">Título del Programa</span>
                    <input 
                      type="text" 
                      className="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 text-lg"
                      placeholder="Ej: Los Cronistas de 6ºA"
                      value={programData.title}
                      onChange={(e) => setProgramData({...programData, title: e.target.value})}
                    />
                  </label>
                  
                  <label className="block">
                    <span className="text-gray-700 font-bold mb-1 block">Temática Principal</span>
                    <input 
                      type="text" 
                      className="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3"
                      placeholder="Ej: El Cambio Climático, Halloween..."
                      value={programData.theme}
                      onChange={(e) => setProgramData({...programData, theme: e.target.value})}
                    />
                  </label>

                   <label className="block">
                    <span className="text-gray-700 font-bold mb-1 block">Duración Total (minutos)</span>
                    <div className="flex items-center gap-2">
                        <input 
                        type="number" 
                        min="1"
                        className="w-24 border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 font-mono"
                        value={programData.duration}
                        onChange={(e) => setProgramData({...programData, duration: parseInt(e.target.value) || 0})}
                        />
                        <span className="text-gray-500 text-sm">minutos estimados</span>
                    </div>
                  </label>
                </div>

                <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                  <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                      <Users className="text-blue-500"/> Equipo de Locutores
                  </h3>
                  
                  <div className="flex gap-2 mb-4">
                    <input 
                      type="text" 
                      className="flex-1 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                      placeholder="Nombre del alumno/a..."
                      value={newPresenter}
                      onChange={(e) => setNewPresenter(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addPresenter()}
                    />
                    <button 
                      onClick={addPresenter}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 active:scale-95 transition-all font-bold"
                    >
                      Añadir
                    </button>
                  </div>
                  
                  <div className="flex-1 bg-gray-50 rounded-lg p-4 border border-gray-100 overflow-y-auto">
                    {programData.presenters.length > 0 ? (
                      <div className="flex flex-wrap gap-2">
                        {programData.presenters.map((p, idx) => (
                          <div key={idx} className="bg-white border border-blue-200 text-blue-800 px-3 py-2 rounded-lg text-sm flex items-center gap-2 shadow-sm animate-in zoom-in duration-200">
                            <span className="font-medium">{p}</span>
                            <button onClick={() => removePresenter(idx)} className="text-gray-400 hover:text-red-500 bg-gray-100 hover:bg-red-50 rounded-full p-1 transition-colors">
                                <Trash2 size={12}/>
                            </button>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center text-gray-400 py-8 flex flex-col items-center">
                          <Users size={32} className="mb-2 opacity-20"/>
                          <p>Añade los nombres de los alumnos que van a hablar.</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="flex justify-end pt-6 border-t border-gray-100">
                <button 
                  onClick={() => setStep(2)}
                  disabled={!programData.title}
                  className="bg-indigo-600 text-white px-8 py-3 rounded-xl hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-indigo-200/50 transition-all flex items-center gap-2 text-lg font-bold"
                >
                  Continuar a la Escaleta <PlayCircle size={20} />
                </button>
              </div>
            </div>
          )}

          {/* --- PASO 2: ESTRUCTURA / ESCALETA --- */}
          {step === 2 && (
            <div className="animate-in slide-in-from-right-4 duration-500 h-full flex flex-col md:flex-row gap-6">
              
              {/* Panel Izquierdo: Lista de Secciones */}
              <div className="flex-1 flex flex-col gap-4">
                
                {/* Monitor de Tiempo */}
                <div className={`p-4 rounded-xl border-2 flex justify-between items-center transition-colors ${isOverTime ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800'}`}>
                   <div className="flex items-center gap-3">
                       <Clock className="w-6 h-6"/>
                       <div>
                           <div className="font-bold text-lg">Tiempo Total: {totalDuration} min</div>
                           <div className="text-xs opacity-75">Objetivo: {programData.duration} min</div>
                       </div>
                   </div>
                   {isOverTime && <span className="bg-red-200 text-red-900 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Exceso de tiempo</span>}
                </div>

                <div className="space-y-3 pb-20">
                    <h3 className="font-bold text-gray-500 uppercase tracking-wider text-xs ml-1">Orden del programa</h3>
                    {sections.map((section, index) => (
                        <div key={section.id} className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow group relative overflow-hidden">
                            {/* Barra lateral de color según tipo */}
                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${
                                section.type === 'intro' ? 'bg-green-500' : 
                                section.type === 'outro' ? 'bg-red-500' : 
                                section.type === 'music' ? 'bg-purple-500' : 'bg-blue-500'
                            }`}></div>

                            <div className="pl-3">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-2">
                                        <span className="bg-gray-100 text-gray-600 font-mono font-bold text-xs w-6 h-6 flex items-center justify-center rounded">{index + 1}</span>
                                        <span className="font-bold text-gray-800">{section.title}</span>
                                    </div>
                                    <div className="flex items-center gap-2 bg-gray-50 p-1 rounded-lg border border-gray-100">
                                        <input 
                                            type="number" 
                                            className="w-12 text-center bg-transparent font-bold text-gray-700 outline-none"
                                            value={section.duration}
                                            onChange={(e) => updateSection(section.id, 'duration', e.target.value)}
                                        />
                                        <span className="text-xs text-gray-400 mr-2">min</span>
                                        {section.type !== 'intro' && section.type !== 'outro' && (
                                            <button onClick={() => removeSection(section.id)} className="text-gray-300 hover:text-red-500 transition-colors px-1">
                                                <Trash2 size={16} />
                                            </button>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-gray-400 mb-1 block">Qué pasa (Contenido)</label>
                                        <textarea 
                                            className="w-full text-sm bg-gray-50 border-gray-200 rounded-lg p-2 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all resize-none"
                                            rows="2"
                                            value={section.description}
                                            onChange={(e) => updateSection(section.id, 'description', e.target.value)}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-blue-400 mb-1 flex items-center gap-1"><Music size={10}/> Indicación Técnica</label>
                                        <input 
                                            type="text" 
                                            className="w-full text-sm bg-blue-50/50 border-blue-100 rounded-lg p-2 text-blue-800 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all font-medium"
                                            value={section.sound}
                                            onChange={(e) => updateSection(section.id, 'sound', e.target.value)}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
              </div>

              {/* Panel Derecho: Toolbox */}
              <div className="md:w-80 flex-shrink-0">
                  <div className="bg-slate-800 text-white rounded-xl p-5 shadow-lg sticky top-24">
                      <h3 className="font-bold mb-4 flex items-center gap-2 text-lg"><Plus className="text-green-400"/> Añadir Bloque</h3>
                      <div className="space-y-2">
                          {sectionTypes.map((type) => (
                              <button 
                                key={type.type}
                                onClick={() => addSection(type)}
                                className="w-full flex items-center justify-between bg-slate-700 hover:bg-slate-600 p-3 rounded-lg transition-all text-left group border border-slate-600 hover:border-slate-500"
                              >
                                  <span className="font-medium text-sm">{type.label}</span>
                                  <span className="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 group-hover:text-white transition-colors">{type.defaultDuration} min</span>
                              </button>
                          ))}
                      </div>

                      <div className="mt-8 pt-6 border-t border-slate-700">
                          <button 
                             onClick={() => setStep(3)}
                             className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-green-500/20 transition-all flex items-center justify-center gap-2"
                          >
                              <FileText /> Ver Guion Final
                          </button>
                          <button onClick={() => setStep(1)} className="w-full mt-3 text-slate-400 hover:text-white text-sm py-2">
                              ← Volver a Datos
                          </button>
                      </div>
                  </div>
              </div>

            </div>
          )}

          {/* --- PASO 3: GUION FINAL --- */}
          {step === 3 && (
            <div className="animate-in slide-in-from-bottom-4 duration-500 max-w-5xl mx-auto">
              
              <div className="flex justify-between items-center mb-6 print:hidden">
                  <button onClick={() => setStep(2)} className="text-gray-500 hover:text-blue-600 font-medium flex items-center gap-2">
                      <RotateCcw size={16}/> Seguir editando
                  </button>
                  <div className="flex gap-3">
                      <button 
                        onClick={downloadCSV}
                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow-sm flex items-center gap-2 font-medium transition-all"
                      >
                          <FileSpreadsheet size={18}/> Exportar Excel (CSV)
                      </button>
                      <button 
                        onClick={() => window.print()}
                        className="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-900 shadow-sm flex items-center gap-2 font-medium transition-all"
                      >
                          <Download size={18}/> Imprimir / PDF
                      </button>
                  </div>
              </div>

              {/* VISTA DEL DOCUMENTO (A4 style) */}
              <div className="bg-white shadow-2xl print:shadow-none min-h-[1000px] w-full p-10 md:p-16 print:p-0 rounded-sm">
                
                {/* Cabecera Guion */}
                <div className="border-b-2 border-black pb-6 mb-8 flex justify-between items-end">
                    <div>
                        <h1 className="text-3xl font-black uppercase tracking-widest font-serif text-gray-900">Guion Radiofónico</h1>
                        <div className="text-sm font-mono mt-2 space-y-1 text-gray-600">
                            <p>PROGRAMA: <span className="text-black font-bold uppercase">{programData.title}</span></p>
                            <p>EMISORA: Radio {programData.school}</p>
                            <p>FECHA: ___________________</p>
                        </div>
                    </div>
                    <div className="text-right font-mono text-sm border-2 border-black p-2 rounded">
                        <p className="font-bold">DURACIÓN ESTIMADA</p>
                        <p className="text-2xl">{totalDuration} min</p>
                    </div>
                </div>

                {/* Tabla Guion */}
                <table className="w-full text-left border-collapse border border-black">
                    <thead className="bg-gray-100 print:bg-gray-200">
                        <tr>
                            <th className="border border-black p-3 font-black text-sm w-24">TIEMPO</th>
                            <th className="border border-black p-3 font-black text-sm w-1/4">CONTROL TÉCNICO</th>
                            <th className="border border-black p-3 font-black text-sm w-32">LOCUTOR/A</th>
                            <th className="border border-black p-3 font-black text-sm">TEXTO / CONTENIDO</th>
                        </tr>
                    </thead>
                    <tbody>
                        {finalScript.map((row, idx) => (
                            <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50 print:bg-white'}>
                                <td className="border border-black p-3 font-mono text-sm align-top">
                                    {row.formattedTime}
                                </td>
                                <td className="border border-black p-3 text-sm font-bold text-blue-900 uppercase align-top bg-blue-50/50 print:text-black print:bg-transparent">
                                    {row.sound}
                                </td>
                                <td className="border border-black p-3 text-sm font-bold align-top">
                                    {row.speakers && row.speakers.includes('Todos') ? 'TODOS' : row.assignedSpeaker.toUpperCase()}
                                </td>
                                <td className="border border-black p-3 text-base font-serif align-top leading-relaxed whitespace-pre-wrap">
                                    {row.generatedText}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>

                {/* Pie de página documento */}
                <div className="mt-12 pt-4 border-t border-gray-300 text-center text-xs text-gray-400 font-mono print:text-black">
                    Generado automáticamente por Asistente de Radio Escolar - CEIP {programData.school}
                </div>

              </div>

            </div>
          )}

        </div>
      </div>
    </div>
  );
}
